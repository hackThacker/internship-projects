<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scanning in Progress...</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        #log-container {
            background-color: #212529;
            color: #dee2e6;
            font-family: 'Courier New', Courier, monospace;
            height: 60vh;
            overflow-y: scroll;
            border-radius: 5px;
            padding: 15px;
            white-space: pre-wrap; /* Ensures lines wrap correctly */
        }
        #log-container .log-crawl { color: #0dcaf0; } /* Cyan */
        #log-container .log-scan { color: #ffc107; } /* Yellow */
        #log-container .log-form { color: #d63384; } /* Pink */
        #log-container .log-complete { color: #198754; font-weight: bold;} /* Green */
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ... (keep all existing styles) ... */
        #log-container .log-phase { color: #6f42c1; font-weight: bold; } /* Indigo */
        #log-container .log-vuln-high { color: #fd7e14; font-weight: bold; } /* Orange */
        #log-container .log-vuln-critical { color: #dc3545; font-weight: bold; } /* Red */
        #log-container .log-error { color: #dc3545; font-weight: bold;} /* Red */
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>Scanning: {{ target_url }}</h3>
                <div id="spinner" class="loader"></div>
            </div>
            <div class="card-body">
                <div id="log-container"></div>
            </div>
             <div class="card-footer text-muted" id="status-footer">
                Scan in progress... please wait. The page will redirect automatically when complete.
            </div>
        </div>
    </div>

    <script>
        const targetUrl = "{{ target_url }}";
        const logContainer = document.getElementById('log-container');
        const spinner = document.getElementById('spinner');
        const statusFooter = document.getElementById('status-footer');

        // The URLSearchParams constructor correctly handles encoding the URL
        const queryParams = new URLSearchParams({url: targetUrl});
        const eventSource = new EventSource(`/stream-scan?${queryParams}`);

        // This function handles incoming log messages from the server
        eventSource.onmessage = function(event) {
            logContainer.innerHTML += event.data + '<br>';
            // Automatically scroll to the bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        };

        // This handles the special 'scan-complete' event
        eventSource.addEventListener('scan-complete', function(event) {
            console.log('Scan complete message received!');
            
            // Add a final success message to the log
            logContainer.innerHTML += '<span class="log-complete">' + event.data + '</span><br>';
            logContainer.scrollTop = logContainer.scrollHeight;

            // Stop the spinner and update the footer
            spinner.style.display = 'none';
            statusFooter.textContent = 'Scan complete! Redirecting to report...';

            // Close the connection to the server
            eventSource.close();
            
            // Redirect to the final report page after 2 seconds
            setTimeout(function() {
                window.location.href = '/report';
            }, 2000);
        });

        // This handles any errors with the stream
        eventSource.onerror = function(err) {
            console.error("EventSource failed:", err);
            statusFooter.textContent = 'Error: Connection to server lost. Scan may have failed.';
            spinner.style.display = 'none';
            eventSource.close();
        };
    </script>
</body>
</html>