from flask import render_template
from collections import Counter

def generate_report_html(**kwargs):
    """
    Analyzes scan results to generate all necessary stats for the
    combined, beautiful dashboard and then renders the template.
    """
    vulnerabilities = kwargs.get('vulnerabilities', [])

    # --- 1. Calculate Stats for KPI Cards ---
    severity_counts = Counter(vuln.get('severity', 'Info') for vuln in vulnerabilities)
    critical_vulns = severity_counts.get('Critical', 0)
    high_vulns = severity_counts.get('High', 0)
    medium_vulns = severity_counts.get('Medium', 0)

    # --- 2. Prepare Data for the Chart.js Doughnut Chart ---
    attack_type_counts = Counter(vuln.get('type') for vuln in vulnerabilities)
    chart_labels = list(attack_type_counts.keys())
    chart_data = list(attack_type_counts.values())

    # --- 3. Add all calculated data to be passed to the template ---
    kwargs['critical_vulns'] = critical_vulns
    kwargs['high_vulns'] = high_vulns
    kwargs['medium_vulns'] = medium_vulns
    kwargs['chart_labels'] = chart_labels
    kwargs['chart_data'] = chart_data
    
    # Render the single, beautiful report template with all the data
    return render_template('report.html', **kwargs)